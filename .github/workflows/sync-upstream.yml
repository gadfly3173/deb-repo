# Sync Upstream Releases
#
# Checks configured upstream GitHub repos for new .deb packages every 4 hours.
# Downloads new packages and rebuilds the APT repository.
#
# Configure upstream repos in upstream-repos.json on master branch.
#
# Required GitHub Secrets (optional):
#   GPG_PRIVATE_KEY  - ASCII-armored GPG private key for signing
#   GPG_PASSPHRASE   - Passphrase for the GPG key

name: Sync Upstream Releases

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

concurrency:
  group: deb-repo-build
  cancel-in-progress: false

permissions:
  contents: write
  pages: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      HAS_GPG_KEY: ${{ secrets.GPG_PRIVATE_KEY != '' }}
    steps:
      - name: Checkout master
        uses: actions/checkout@v4

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-repo
          fetch-depth: 0
        continue-on-error: true

      - name: Initialize output directory
        run: |
          if [ ! -d gh-pages-repo/.git ]; then
            mkdir -p gh-pages-repo
          fi
          mkdir -p gh-pages-repo/pool/main

      - name: Sync upstream packages
        id: sync
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./scripts/sync-upstream.sh upstream-repos.json gh-pages-repo/pool/main

      - name: Import GPG key
        if: env.HAS_GPG_KEY == 'true'
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          echo "${GPG_PRIVATE_KEY}" | gpg --batch --import
          GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format long 2>/dev/null | grep 'sec' | head -1 | awk '{print $2}' | cut -d'/' -f2)
          echo "GPG_KEY_ID=${GPG_KEY_ID}" >> "$GITHUB_ENV"

      - name: Build repository
        if: steps.sync.outputs.new_packages != '0'
        env:
          GPG_KEY_ID: ${{ env.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: ./scripts/build-repo.sh gh-pages-repo

      - name: Export GPG public key
        if: env.HAS_GPG_KEY == 'true' && steps.sync.outputs.new_packages != '0'
        run: gpg --export --armor > gh-pages-repo/public.key

      - name: Generate pages
        if: steps.sync.outputs.new_packages != '0'
        run: |
          REPO_URL="https://$(echo ${{ github.repository }} | cut -d'/' -f1).github.io/$(echo ${{ github.repository }} | cut -d'/' -f2)"
          ./scripts/generate-pages.sh gh-pages-repo "${REPO_URL}" templates

      - name: Deploy to gh-pages
        if: steps.sync.outputs.new_packages != '0'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-repo
          keep_files: true
          force_orphan: false

      - name: No changes
        if: steps.sync.outputs.new_packages == '0'
        run: echo "No new packages found. Repository is up to date."
